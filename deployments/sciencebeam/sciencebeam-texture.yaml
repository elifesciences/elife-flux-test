---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: sciencebeam-texture
  namespace: prod
  annotations:
    fluxcd.io/automated: 'true'
    filter.fluxcd.io/chart-image: semver:*

spec:
  releaseName: sciencebeam-texture--prod
  chart:
    git: https://github.com/elifesciences/sciencebeam-texture
    path: charts/sciencebeam-texture
    ref: develop

  values:
    image:
      repository: elifesciences/sciencebeam_texture
      tag: 0.0.12
    ingress:
      enabled: "true"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
      hosts:
      - host: sciencebeam-texture.elifesciences.org
        paths:
        - "/"
      - host: sciencebeam.org
        paths:
        - "/"
      tls:
      - secretName: sciencebeam-letsencrypt-cert
        hosts:
        - sciencebeam.org

    resources:
      requests:
        memory: 128Mi
---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: sciencebeam-texture-sciencebeam
  namespace: prod
  annotations:
    fluxcd.io/automated: 'true'
    filter.fluxcd.io/chart-image: semver:*
    filter.fluxcd.io/grobid: glob:*

spec:
  releaseName: sciencebeam-texture-sciencebeam--prod
  chart:
    git: https://github.com/elifesciences/sciencebeam-charts
    path: sciencebeam-pipelines
    ref: develop

  values:
    image:
      repository: elifesciences/sciencebeam-pipelines
      tag: 0.1.2
    env:
      SCIENCEBEAM__XSLT_TEMPLATE_PARAMETERS__ACKNOWLEDGEMENT_TARGET: "body"
      SCIENCEBEAM__XSLT_TEMPLATE_PARAMETERS__ANNEX_TARGET: "body"
    grobid:
      image:
        repository: elifesciences/grobid_unstable
        tag: "72fcce29839111c955ae5d6438fba62436bccbc8"
      env:
        GROBID__FEATURES__REMOVE_LINE_NUMBERS: "false"
        GROBID__3RDPARTY__PDF2XML__MEMORY__TIMEOUT__SEC: "300"
        GROBID__PDF__BLOCKS__MAX: "1000000"
        GROBID__PDF__TOKENS__MAX: "10000000"
        GROBID__HEADER__USE_LABELED_ABSTRACT: "false"
      warmup:
        enabled: false
        image:
          repository: pstauffer/curl
          tag: v1.0.3
      resources:
        requests:
          memory: 3Gi
        limits:
          memory: 8Gi
    ingress:
      enabled: "true"
      hosts:
      - host: sciencebeam-texture.elifesciences.org
        paths:
        - "/api"
      - host: sciencebeam.org
        paths:
        - "/api"
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: 120m
    resources:
      requests:
        memory: 128Mi
---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: sciencebeam-texture-sciencebeam-biorxiv
  namespace: prod
  annotations:
    fluxcd.io/automated: 'true'
    filter.fluxcd.io/chart-image: semver:*
    filter.fluxcd.io/grobid: glob:*-dl-no-word-embeddings-wapiti-citation

spec:
  releaseName: sciencebeam-texture-sciencebeam-biorxiv--prod
  chart:
    git: https://github.com/elifesciences/sciencebeam-charts
    path: sciencebeam-parser
    ref: develop

  values:
    image:
      repository: elifesciences/sciencebeam-parser_unstable
      tag: "e9a9cf54fbc8f0b043dcf2f530e348afba78d4bd"
    env:
      SCIENCEBEAM_PARSER__XSLT__TEI_TO_JATS__PARAMETERS__ACKNOWLEDGEMENT_TARGET: "body"
      SCIENCEBEAM_PARSER__XSLT__TEI_TO_JATS__PARAMETERS__ANNEX_TARGET: "body"
      SCIENCEBEAM_PARSER__PRELOAD_ON_STARTUP: "true"
    ingress:
      enabled: "true"
      hosts:
      - host: sciencebeam-texture.elifesciences.org
        paths:
        - "/api_biorxiv(/|$)(.*)"
      - host: sciencebeam.org
        paths:
        - "/api_biorxiv(/|$)(.*)"
      annotations:
        nginx.ingress.kubernetes.io/rewrite-target: /api/$2
        nginx.ingress.kubernetes.io/proxy-body-size: 120m
        nginx.ingress.kubernetes.io/proxy-connect-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "180"
    resources:
      requests:
        memory: 3Gi
      limits:
        memory: 8Gi
