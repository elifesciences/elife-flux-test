apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: namespace-to-nodeselector-cluster-services
  annotations:
    policies.kyverno.io/title: Add nodeSelector and toleration to pods in cluster-services namespaces
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
spec:
  rules:
  - name: add-nodeselector
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          kinds:
          - Pod
          namespaces:
          - kube-system
          - "basex-validator*"
          - "data-hub*"
          - "epp*"
          - "journal*"
          - "peerscout*"
          - "sciety*"
    preconditions:
      all:
      - key: "{{ [request.\"object\".metadata.ownerReferences[].kind, [request.\"object\".kind]][] }}"
        operator: AllNotIn
        value: DaemonSet
        message: DaemonSets should probably be allocated to all node, regardless of pool
      - key: "{{ [request.\"object\".spec.template.spec.tolerations, request.\"object\".spec.tolerations][].key }}"
        operator: AllNotIn
        value: CriticalAddonsOnly
        message: This workload should be allocated to the core NodePool, not reallocated to cluster services
    mutate:
      patchStrategicMerge:
        spec:
          nodeSelector:
            Project: flux-test
