apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: amazon-network-flow-monitor
  namespace: amazon-network-flow-monitor
spec:
  jobLabel: name
  namespaceSelector:
    matchNames:
    - amazon-network-flow-monitor
  selector:
    matchLabels:
      name: aws-network-flow-monitor-agent
  podMetricsEndpoints:
  - path: /metrics
    portNumber: 9109
---
# Workaround because amazon's addon doesn't specify a container port, so we can't automatically scrape it
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: amazon-network-flow-monitor-raw
  namespace: amazon-network-flow-monitor
spec:
  jobName: amazon-network-flow-monitor

  kubernetesSDConfigs:
  - namespaces:
      names:
      - amazon-network-flow-monitor
    role: pod

  relabelConfigs:
    - action: keep
      sourceLabels: [__meta_kubernetes_pod_label_name]
      regex: aws-network-flow-monitor-agent
    - action: keep
      sourceLabels: [__meta_kubernetes_pod_phase]
      regex: Running
    - sourceLabels: [__address__]
      regex: ([^:]+)(?::\d+)?
      replacement: $1:9109
      targetLabel: __address__
