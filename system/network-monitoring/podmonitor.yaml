apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: amazon-network-flow-monitor
  namespace: amazon-network-flow-monitor
spec:
  jobLabel: name
  namespaceSelector:
    matchNames:
    - amazon-network-flow-monitor
  selector:
    matchLabels:
      name: aws-network-flow-monitor-agent
  podMetricsEndpoints:
  - path: /metrics
    portNumber: 9109
---
# Workaround because amazon's addon doesn't specify a container port, so we can't automatically scrape it
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMScrapeConfig
metadata:
  name: amazon-network-flow-monitor-raw
  namespace: amazon-network-flow-monitor
spec:
  jobLabel: name
  config:
    job_name: 'amazon-network-flow-monitor'
    kubernetes_sd_configs:
    - role: pod
      namespaces:
        names:
          - amazon-network-flow-monitor
    relabel_configs:
      # --- DEBUGGING SECTION ---
      # 1. Expose the hidden Pod Name as a visible label "debug_name"
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: debug_name

      # 2. Expose the hidden Pod Phase as a visible label "debug_phase"
      - source_labels: [__meta_kubernetes_pod_phase]
        target_label: debug_phase

      # 3. Expose the hidden IP address as a visible label "debug_ip"
      - source_labels: [__address__]
        target_label: debug_ip

      # --- NO FILTERS ---
      # I have deleted all "action: keep" rules.
      # This forces vmagent to accept EVERY pod in the namespace.

      # --- PORT FIX ---
      # We still need this, or the target address will be invalid.
      - source_labels: [__address__]
        regex: ([^:]+)(?::\d+)?
        replacement: $1:9109
        target_label: __address__
