---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: alloy

spec:
  interval: 1m
  timeout: 10m
  releaseName: alloy
  chart:
    spec:
      chart: alloy
      version: 0.1.1
      sourceRef:
        kind: HelmRepository
        name: grafana
      interval: 1m
  install:
    remediation:
      retries: 5

  values:
    alloy:
      configMap:
        content: |-
          logging {
            level = "info"
            format = "logfmt"
          }

          prometheus.remote_write "mimir" {
            endpoint {
              url = "http://mimir-nginx.mimir/api/v1/push"
            }
          }


          prometheus.exporter.unix "node_stats" { }
          prometheus.scrape "node_stats" {
            targets    = prometheus.exporter.unix.node_stats.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }

          discovery.kubernetes "ksm" {
            role = "pod"
            namespaces {
               own_namespace = true
            }
            selectors {
              role  = "pod"
              label = "app.kubernetes.io/component=metrics"
            }
          }
          prometheus.scrape "ksm" {
            targets    = discovery.kubernetes.ksm.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }
