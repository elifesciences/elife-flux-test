apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victorialogs
spec:
  releaseName: victorialogs
  chart:
    spec:
      chart: victoria-logs-single
      sourceRef:
        kind: HelmRepository
        name: victoriametrics
      version: "0.11.23"
  interval: 1h0m0s
  values:
    server:
      retentionPeriod: 30d
      persistentVolume:
        enabled: true
        storageClassName: ebs-gp3
        size: 8Gi
      ingress:
        enabled: true
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt"
          nginx.ingress.kubernetes.io/auth-url: "${oauth2_proxy_auth_url}"
          nginx.ingress.kubernetes.io/auth-signin: "${oauth2_proxy_auth_signin}"
        hosts:
          - name: victorialogs.${cluster_domain}
            path: /select
            port: http
        tls:
          - secretName: victorialogs-tls
            hosts:
              - victorialogs.${cluster_domain}
    fluent-bit:
      enabled: false
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    external-dns.alpha.kubernetes.io/controller: "disabled"
    traefik.ingress.kubernetes.io/router.middlewares: traefik-elife-oauth@kubernetescrd
  name: victorialogs-victoria-logs-single-server-traefik
  namespace: victorialogs
spec:
  ingressClassName: traefik
  rules:
    - host: victorialogs.flux-test.elifesciences.org
      http:
        paths:
          - backend:
              service:
                name: victorialogs-victoria-logs-single-server
                port:
                  name: http
            path: /select
            pathType: Prefix
  tls:
    - hosts:
        - victorialogs.flux-test.elifesciences.org
      secretName: victorialogs-tls
