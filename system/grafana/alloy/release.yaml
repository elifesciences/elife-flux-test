---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: alloy

spec:
  interval: 1m
  timeout: 10m
  releaseName: alloy
  chart:
    spec:
      chart: alloy
      version: 0.1.1
      sourceRef:
        kind: HelmRepository
        name: grafana
      interval: 1m
  install:
    remediation:
      retries: 5

  values:
    alloy:
      clustering:
        enabled: true
      configMap:
        content: |-
          logging {
            level = "info"
            format = "logfmt"
          }

          prometheus.remote_write "mimir" {
            endpoint {
              url = "http://mimir-nginx/api/v1/push"
            }
          }

          // node_exporter metrics
          prometheus.exporter.unix "node_stats" { }
          prometheus.scrape "node_stats" {
            targets    = prometheus.exporter.unix.node_stats.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }

          // kube-state-metrics metrics
          discovery.kubernetes "ksm" {
            role = "pod"
            namespaces {
               own_namespace = true
            }
            selectors {
              role  = "pod"
              label = "app.kubernetes.io/component=metrics"
            }
          }
          prometheus.scrape "ksm" {
            targets    = discovery.kubernetes.ksm.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }

          // cadvisor metrics
          // prometheus.exporter.cadvisor "cadvisor" { }
          prometheus.operator.servicemonitors "cadvisor" {
            forward_to = [prometheus.remote_write.mimir.receiver]
            namespaces = ["grafana"]
            selector {
              match_expression {
                  key = "workaround-for"
                  operator = "In"
                  values = ["alloy-and-cadvisor"]
                }
              }
          }
          prometheus.scrape "cadvisor" {
            targets    = prometheus.exporter.cadvisor.cadvisor.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }

          // node metrics
          discovery.kubernetes "node" {
            role = "node"
          }
          prometheus.scrape "node" {
            targets    = discovery.kubernetes.node.targets
            forward_to = [prometheus.remote_write.mimir.receiver]
          }
