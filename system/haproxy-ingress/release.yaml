---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: haproxy-ingress
  namespace: haproxy-ingress

spec:
  interval: 1m
  chart:
    spec:
      chart: haproxy-ingress
      version: 0.15.0
      sourceRef:
        kind: HelmRepository
        name: haproxy-ingress
      interval: 1m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  values:
    controller:
      replicaCount: 5
      ingressClassResource:
        enabled: true
        name: haproxy
        default: false
      service:
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: "external"
          service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: 'false'
          service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
          service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      publishService:
         enabled: true

      config:
        use-proxy-protocol: "true"
        h2: "true"
        compression-algo: "gzip"
        gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml"
        use-forwarded-headers: "true"
        syslog-endpoint: "stdout"
        syslog-format: "raw"
        http-log-format: |
          {"timestamp": "%tr", "requestID": "%ID", "proxyUpstreamName": "%b", "proxyAlternativeUpstreamName": "", "proxyProtocolAddr":"%cp", "proxyProtocolPort":"%sp", "upstreamStatus": "%ST", "upstreamAddr": "%si:%sp","httpRequest":{"requestMethod": "%HM", "requestUrl": "%[hdr(host)]%HU", "status": %ST,"requestSize": "%U", "responseSize": "%B", "userAgent": "%[capture.req.hdr(0)]", "remoteIp": "%ci", "referer": "%[capture.req.hdr(1)]", "latency": "%Tt ms", "protocol":"%HV", "xForwardedFor": "%[hdr(X-Forwarded-For)]", "xOriginalForwardedFor": "", "xForwardedHost": "%[hdr(X-Forwarded-Host)]"}}

        # To capture UserAgent and Referer for the log format above, we must explicitly capture them.
        http-log-receiver: |
          captured-headers: "User-Agent,Referer"

    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
