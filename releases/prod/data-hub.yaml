---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: data-hub
  namespace: prod
  annotations:
    fluxcd.io/automated: 'true'
    filter.fluxcd.io/chart-image: semver:*

spec:
  releaseName: data-hub--flux
  chart:
    repository: https://airflow-helm.github.io/charts
    name: airflow
    version: 8.4.1

  values:
    ingress:
      enabled: true
      web:
        host: data-hub--flux.elifesciences.org
        annotations:
          nginx.ingress.kubernetes.io/auth-url: "https://auth--test-cluster.elifesciences.org/oauth2/auth"
          nginx.ingress.kubernetes.io/auth-signin: "https://auth--test-cluster.elifesciences.org/oauth2/start?rd=https%3A%2F%2F$host$request_uri"
    airflow:
      legacyCommands:
        enabled: true
      config:
        AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "True"
      image:
        repository: elifesciences/data-hub-with-dags
        tag: 0.0.73
      extraEnv:
        # config file paths:
        - name: GMAIL_DATA_CONFIG_FILE_PATH
          value: /dag_config_files/gmail-data-pipeline.config.yaml
        - name: CROSSREF_CONFIG_FILE_PATH
          value: /dag_config_files/crossref-event-data-pipeline.config.yaml
        - name: SPREADSHEET_CONFIG_FILE_PATH
          value: /dag_config_files/spreadsheet-data-pipeline.config.yaml
        - name: WEB_API_CONFIG_FILE_PATH
          value: /dag_config_files/web-api-data-pipeline.config.yaml
        - name: S3_CSV_CONFIG_FILE_PATH
          value: /dag_config_files/s3-csv-data-pipeline.config.yaml
        - name: WEB_API_CONFIG_FILE_PATH
          value: /dag_config_files/web-api-data-pipeline.config.yaml
        - name: MONITORING_CONFIG_FILE_PATH
          value: monitoring.config.yaml
        
        # scheduler interval
        - name: GMAIL_DATA_PIPELINE_SCHEDULE_INTERVAL
          value: "0 7 * * 1-5"
        - name: CROSS_REF_IMPORT_SCHEDULE_INTERVAL
          value: "@daily"
        - name: GOOGLE_SPREADSHEET_SCHEDULE_INTERVAL
          value: "@daily"
        - name: WEB_API_SCHEDULE_INTERVAL
          value: "@daily"
        - name: S3_CSV_SCHEDULE_INTERVAL
          value: "@hourly"
        - name: WEB_API_SCHEDULE_INTERVAL
          value: "@daily"
        - name: MONITOR_DATA_HUB_PIPELINE_HEALTH_SCHEDULE_INTERVAL
          value: "@daily"

        # general:
        - name: DEPLOYMENT_ENV
          value: flux
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /dag_secret_files/gcloud/credentials.json
        - name: GMAIL_ACCOUNT_SECRET_FILE
          value: /dag_secret_files/gmail/gmail_credentials.json
        - name: IS_GMAIL_END2END_TEST
          value: "False"
        - name: INITIAL_S3_FILE_LAST_MODIFIED_DATE
          value: "2020-02-14 13:00:00"
        - name: DATA_HUB_MONITORING_SLACK_WEBHOOK_URL
          value: https://hc-ping.com/dbc47ad7-9d1b-4e2d-be31-5380764c1b02

    workers:
      extraVolumeMounts:
      - name: data-hub-config-volume
        mountPath: /dag_config_files/
        readOnly: true
      - name: gcloud-secret-volume
        mountPath: /dag_secret_files/gcloud/
        readOnly: true
      - name: aws-secret-volume
        mountPath: /home/airflow/.aws
        readOnly: true
      - name: gmail-secret-volume
        mountPath: /dag_secret_files/gmail/
        readOnly: true
      - name: toggl-secret-volume
        mountPath: /home/airflow/toggl
        readOnly: true
      - name: civi-secret-volume
        mountPath: /home/airflow/civi_key
        readOnly: true
      - name: civi-secret-volume
        mountPath: /home/airflow/civi_key
        readOnly: true

      extraVolumes:
      - name: data-hub-config-volume
        configMap:
          name: data-hub-configs
      - name: gcloud-secret-volume
        secret:
          secretName: gcloud
      - name: aws-secret-volume
        secret:
          secretName: credentials
      - name: gmail-secret-volume
        secret:
          secretName: gmail-credentials
      - name: toggl-secret-volume
        secret:
          secretName: toggl
      - name: twitter-secret-volume
        secret:
          secretName: twitter
      - name: civi-secret-volume
        secret:
          secretName: civi-key
