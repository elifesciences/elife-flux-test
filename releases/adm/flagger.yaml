---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: flagger
  namespace: adm

spec:
  chart:
    repository: https://flagger.app
    name: flagger
    version: 1.0.0

  values:
    metricsServer: http://adm-prometheus-operator-prometheus:9090
    meshProvider: nginx

---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: flagger-loadtester
  namespace: adm

spec:
  chart:
    repository: https://flagger.app
    name: loadtester
    version: 0.17.0

  values:
    rbac:
      create: true
      scope: cluster
      rules:
        - apiGroups: [""]
          resources: ["secrets"]
          verbs: ["get", "watch", "list", "update"]
        # choose the permission based on helm test type (Pod or Job)
        - apiGroups: [""]
          resources: ["pods", "pods/log"]
          verbs: ["create", "list", "delete", "watch"]
        - apiGroups: ["batch"]
          resources: ["jobs", "jobs/log"]
          verbs: ["create", "list", "delete", "watch"]

---
apiVersion: flagger.app/v1beta1
kind: MetricTemplate
metadata:
  name: request-success-rate--custom-namespace
  namespace: adm
  description: "Needed if ingress controller resides different namespace"
spec:
  provider:
    type: prometheus
    address: http://adm-prometheus-operator-prometheus:9090
  query: >
    sum(
        rate(
          nginx_ingress_controller_requests{
            namespace="{{ namespace }}",
            ingress="{{ ingress }}",
            status!~"5.*"
          }[{{ interval }}]
        )
      )
      /
      sum(
        rate(
          nginx_ingress_controller_requests{
            namespace="{{ namespace }}",
            ingress="{{ ingress }}"
          }[{{ interval }}]
        )
      )
      * 100
